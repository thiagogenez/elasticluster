---

- name: Version compatibility check (1)
  fail:
    msg: "Python 2 is only available in Anaconda version 2019.10 or less, but Anaconda {{ anaconda_version }} was requested.  To proceed, please set `anaconda_version` to version 2019.10 or earlier, or set `anaconda_python_version=3` and then retry."
  when: 'anaconda_python_version|int == 2 and anaconda_version.split(".")[0]|int >= 2020'

- name: Version compatibility check (2)
  fail:
    msg: "Anaconda 2019.10 has a bug and cannot be installed on machines with one vCPU only; see https://github.com/ContinuumIO/anaconda-issues/issues/11466. To proceed, please set `anaconda_version` to version 2019.07, and then retry."
  when: 'ansible_processor_vcpus|int == 2 and anaconda_version == "2019.10"'

# need to do this here, as the Anaconda packages are not yet installed
- name: Create `anaconda` system user
  user:
    name: '{{anaconda_username}}'
    system: yes
    create_home: no


- name: Download Anaconda installer script
  get_url:
    url: '{{anaconda_installer_url}}'
    dest: '{{anaconda_installer_sh}}'
    owner: root
    group: root
    mode: 0755
    validate_certs: '{{ not insecure_https_downloads|default("no")|bool }}'

- name: Install Anaconda
  command: '{{anaconda_installer_sh}} -b -f -p {{anaconda_home}}'
  args:
    creates: '{{anaconda_home}}/bin/conda'

- name: Delete Anaconda installer script
  file:
    path: '{{anaconda_installer_sh}}'
    state: absent
  when: anaconda_cleanup

- name: make Anaconda Python the first match in $PATH
  template:
    src: 'etc/profile.d/anaconda.sh.j2'
    dest: '/etc/profile.d/anaconda{{anaconda_python_version}}.sh'
    mode: '0444'
    owner: root
    group: root
  when: anaconda_in_path

- name: Make convenience symlink to Anaconda home
  ansible.builtin.file:
    dest: '/{{item}}/anaconda{{anaconda_python_version}}'
    src: '{{anaconda_home}}'
    state: link
    owner: '{{anaconda_username}}'
    group: '{{anaconda_groupname}}'
  loop:
    - opt
    - '{{anaconda_install_path}}'


- name: Add extra channels
  ansible.builtin.command: '{{anaconda_home}}/bin/conda config --add channels {{item}}'
  loop: '{{anaconda_extra_channels  | from_yaml | default(["defaults"]) }}'
  when: 'item is defined'

- name: Update anaconda and conda itself
  ansible.builtin.command: '{{anaconda_home}}/bin/conda update -y conda anaconda'

- name: Update all packages
  ansible.builtin.command: '{{anaconda_home}}/bin/conda update --all -y'


- name: Explicitly change the ownership of the '{{anaconda_home}}' folder, and all subfolders, from root to ‘anaconda’,
  ansible.builtin.command: chown -R anaconda:anaconda '{{anaconda_home}}'

- name: Explicitly remove write permission for ‘group’ and ‘others’ — we don’t want them messing up our anaconda directory!
  ansible.builtin.command: chmod -R go-w '{{anaconda_home}}'

- name: Explicitly give ‘group’ and ‘others’ read and execute permissions
  ansible.builtin.command: chmod -R go+rX '{{anaconda_home}}'

- name: Create shared place for multi-user setup
  ansible.builtin.file:
    path: '{{anaconda_shared}}/pkgs'
    state: directory
    owner: 'root'
    group: 'root'

- name: Explicitly set the permissions to enable other users to write to at the shared place '{{anaconda_shared}}'/..
  ansible.builtin.command: chmod -R oug+rwx '{{anaconda_shared}}/..'    

  
- name: Install shared_env with extra packages [{{anaconda_extra_packages | from_yaml |join(" ") }}] in a shared environment
  ansible.builtin.command: '{{anaconda_home}}/bin/conda -n shared_env -y {{anaconda_extra_packages | from_yaml |join(" ") }}'
  when: 'anaconda_extra_packages is defined'
  become: yes
  become_user: '{{anaconda_username}}'

